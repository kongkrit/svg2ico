<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <title>SVG to ICO Converter</title>
    <style>
        /* CSS: Dark Theme match */
        body { 
            font-family: sans-serif; 
            max-width: 600px; 
            margin: 2rem auto; 
            background-color: #1e1e1e; 
            color: #e0e0e0; 
            text-align: center;
        }
        h1 { margin-bottom: 2rem; color: #fff; }
        
        .upload-area { 
            border: 2px dashed #444; 
            padding: 3rem; 
            border-radius: 4px; 
            background-color: #252525;
            cursor: pointer;
            transition: 0.2s;
        }
        .upload-area:hover { border-color: #888; background-color: #2a2a2a; }

        .preview-container { margin-top: 2rem; }
        #preview-title { 
            margin-bottom: 0.5rem; 
            color: #888; 
        }
        canvas { 
            border: 1px solid #444; 
            background-image: linear-gradient(45deg, #2a2a2a 25%, transparent 25%), linear-gradient(-45deg, #2a2a2a 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #2a2a2a 75%), linear-gradient(-45deg, transparent 75%, #2a2a2a 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        
        button {
            margin-top: 1.5rem;
            padding: 0.8rem 1.5rem;
            background: #66bb6a;
            color: #000;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
        }
        button:disabled { background: #444; color: #888; cursor: not-allowed; }
        button:hover:not(:disabled) { background: #81c784; }

        .hidden { display: none; }
        .error { color: #ff5252; margin-top: 1rem; }
    </style>
</head>
<body>

    <h1>SVG to ICO Converter</h1>
    
    <div id="drop-zone" class="upload-area">
        <p>Click or Drag & Drop SVG file</p>
        <input type="file" id="file-input" accept=".svg" class="hidden">
    </div>



    <div id="preview-section" class="preview-container hidden">
        <p id="preview-title">Preview</p>
        <canvas id="preview-canvas"></canvas>
        <br>
        <button id="download-btn">Download .ICO</button>
    </div>

    <div id="error-msg" class="error"></div>

<script>
// --- Configuration ---
const outputSize = 256;

// --- Utility ---
const byId = id => document.getElementById(id);

// --- DOM elements ---
const dom = {
    dropZone: byId("drop-zone"),
    fileInput: byId("file-input"),
    previewSection: byId("preview-section"),
    previewTitle: byId("preview-title"),
    canvas: byId("preview-canvas"),
    btn: byId("download-btn"),
    error: byId("error-msg")
};

// Set initial text for titles
if (dom.previewTitle) dom.previewTitle.textContent = `Preview (${outputSize}x${outputSize})`;

let currentFileName = "icon";
let currentImg = null;

// --- Logic ---

function triggerDownload(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Constructs a valid ICO binary format containing the PNG data
async function createIcoBlob(pngBlob) {
    const pngBuffer = await pngBlob.arrayBuffer();
    const pngSize = pngBuffer.byteLength;
    
    // ICO Header (6 bytes) + Directory Entry (16 bytes) = 22 bytes offset
    const headerSize = 6;
    const dirEntrySize = 16;
    const offset = headerSize + dirEntrySize;
    
    const buffer = new ArrayBuffer(offset + pngSize);
    const view = new DataView(buffer);
    
    // --- ICO Header ---
    view.setUint16(0, 0, true); // Reserved
    view.setUint16(2, 1, true); // Type (1 = ICO)
    view.setUint16(4, 1, true); // Count (1 image)

    // --- Directory Entry ---
    const w = outputSize >= 256 ? 0 : outputSize;
    const h = outputSize >= 256 ? 0 : outputSize;
    view.setUint8(6, w);    // Width
    view.setUint8(7, h);    // Height
    view.setUint8(8, 0);    // Colors (0 = No palette)
    view.setUint8(9, 0);    // Reserved
    view.setUint16(10, 1, true); // Color Planes
    view.setUint16(12, 32, true); // Bits per pixel
    view.setUint32(14, pngSize, true); // Size of PNG data
    view.setUint32(18, offset, true);  // Offset where PNG data starts

    // --- Copy PNG Data ---
    const pngArray = new Uint8Array(pngBuffer);
    const finalArray = new Uint8Array(buffer);
    finalArray.set(pngArray, offset);

    return new Blob([buffer], { type: 'image/x-icon' });
}

function processFile(file) {
    if (file.type !== 'image/svg+xml') {
        dom.error.textContent = "Please upload a valid .svg file";
        return;
    }

    dom.error.textContent = "";
    currentFileName = file.name.replace(/\.svg$/i, '.ico');
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            currentImg = img;
            
            // Setup preview
            dom.canvas.width = outputSize;
            dom.canvas.height = outputSize;
            const ctx = dom.canvas.getContext('2d');
            ctx.clearRect(0, 0, outputSize, outputSize);
            ctx.drawImage(img, 0, 0, outputSize, outputSize);
            dom.previewSection.classList.remove('hidden');
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// --- Event Listeners ---

dom.dropZone.addEventListener('click', () => dom.fileInput.click());

dom.fileInput.addEventListener('change', (e) => {
    if (e.target.files[0]) processFile(e.target.files[0]);
});

dom.dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dom.dropZone.style.borderColor = '#888';
});
dom.dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dom.dropZone.style.borderColor = '#444';
});
dom.dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dom.dropZone.style.borderColor = '#444';
    if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
});

dom.btn.addEventListener('click', () => {
    if (!currentImg) return;
    
    // Generate output at outputSize
    const offCanvas = document.createElement('canvas');
    offCanvas.width = outputSize;
    offCanvas.height = outputSize;
    const ctx = offCanvas.getContext('2d');
    ctx.drawImage(currentImg, 0, 0, outputSize, outputSize);
    
    offCanvas.toBlob(async (blob) => {
        if (blob) {
            const icoBlob = await createIcoBlob(blob);
            triggerDownload(icoBlob, currentFileName);
        }
    }, 'image/png');
});
</script>
</body>
</html>
